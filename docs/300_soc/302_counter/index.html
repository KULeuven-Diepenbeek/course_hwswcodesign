<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.123.7">
    <meta name="description" content="">
<meta name="author" content="map[email:&lt;i&gt;fname&lt;/i&gt;.&lt;i&gt;lname&lt;/i&gt;A T&lt;i&gt;kuleuven.be&lt;/i&gt; name:Jo Vliegen]">

    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>302 - Counter peripheral :: HW/SW codesign</title>

    
    <link href="../../css/nucleus.css?1739605499" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1739605499" rel="stylesheet">
    <link href="../../css/hybrid.css?1739605499" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1739605499" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1739605499" rel="stylesheet">
    <link href="../../css/auto-complete.css?1739605499" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css?1739605499" rel="stylesheet">
    <link href="../../css/theme.css?1739605499" rel="stylesheet">
    <link href="../../css/tabs.css?1739605499" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1739605499" rel="stylesheet">
    
    <link href="../../css/theme-kul.css?1739605499" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1739605499"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src=../../js/exercises.js></script> 
  </head>
  <body class="" data-url="../../300_soc/302_counter/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://www.kuleuven.be/kuleuven/" target="_blank">
  <img src="../../img/style/kul.png" alt="KU Leuven" /><br/>
</a>
<a href="https://www.uhasselt.be/" target="_blank">
  <img src="../../img/style/uhasselt.svg" alt="UHasselt" id="uhlogo" />
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1739605499"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1739605499"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/kuleuven-diepenbeek.github.io\/course_hwswcodesign\/";
    
</script>
<script type="text/javascript" src="../../js/search.js?1739605499"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/10_compiling/" title="1 Setting the playing field" class="dd-item
        
        
        
        ">
      <a href="../../10_compiling/">
          1 Setting the playing field
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/11_programming/" title="1.1 - Programming the RISC-V" class="dd-item ">
        <a href="../../10_compiling/11_programming/">
        <i class='fas fa-book'></i> 1.1 - Programming the RISC-V
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/12_compiling_bare_metal/" title="1.2 - Compiling Bare Metal" class="dd-item ">
        <a href="../../10_compiling/12_compiling_bare_metal/">
        <i class='fas fa-book'></i> 1.2 - Compiling Bare Metal
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/13_linking_bare_metal/" title="1.3 - Linking Bare Metal" class="dd-item ">
        <a href="../../10_compiling/13_linking_bare_metal/">
        <i class='fas fa-book'></i> 1.3 - Linking Bare Metal
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/14_simulation/" title="1.4 - Simulation" class="dd-item ">
        <a href="../../10_compiling/14_simulation/">
        <i class='fas fa-book'></i> 1.4 - Simulation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/15_exercises/" title="1.5 - Exercises" class="dd-item ">
        <a href="../../10_compiling/15_exercises/">
        <i class='fas fa-pen'></i> 1.5 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/20_hw/" title="2 Making it work on hardware" class="dd-item
        
        
        
        ">
      <a href="../../20_hw/">
          2 Making it work on hardware
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/20_hw/21_current_situation/" title="2.1 - The current situation" class="dd-item ">
        <a href="../../20_hw/21_current_situation/">
        <i class='fas fa-book'></i> 2.1 - The current situation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/22_wrapping/" title="2.2 - Wrapping it up" class="dd-item ">
        <a href="../../20_hw/22_wrapping/">
        <i class='fas fa-book'></i> 2.2 - Wrapping it up
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/23_onemore/" title="2.3 - One more thing ..." class="dd-item ">
        <a href="../../20_hw/23_onemore/">
        <i class='fas fa-book'></i> 2.3 - One more thing ...
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/24_ooc/" title="2.4 - Go as fast as you can" class="dd-item ">
        <a href="../../20_hw/24_ooc/">
        <i class='fas fa-book'></i> 2.4 - Go as fast as you can
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/25_exercises/" title="2.5 - Exercises" class="dd-item ">
        <a href="../../20_hw/25_exercises/">
        <i class='fas fa-pen'></i> 2.5 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://studiegidswww.uhasselt.be/opleidingsonderdeel.aspx?a=2023&amp;i=3468&amp;n=4&amp;t=04"><i class='fa fa-university'></i> ECTS Sheet</a>
              </li>
          
              <li>
                  <a class="padding" href="https://p.cygnus.cc.kuleuven.be/webapps/blackboard/execute/announcement?method=search&amp;context=course&amp;course_id=_1176295_1&amp;handle=cp_announcements&amp;mode=cpview"><i class='fa fa-university'></i> Toledo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../'>HWSW codesign</a> > <a href=''>3  System on Chip</a> > 302 - Counter peripheral
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#gluing-things-together">Gluing things together</a></li>
    <li><a href="#memory-map">Memory map</a>
      <ul>
        <li><a href="#double-drivers">Double drivers</a></li>
      </ul>
    </li>
    <li><a href="#example">Example</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              302 - Counter peripheral
            </h1>
          

        


<p>When a hardware/software codesign is made, we need to be able to <strong>measure</strong> the performance. A simple way to achieve this, is counting how many clock cycles certain operations take. Later on, this shall be revisited, but the peripheral will be useful (<em>pinky swear</em>).</p>
<div class="multiHcolumn">
<div class="column">
  <p><img src="../../img/300/counter.png" alt="example"></p>
</div>    
<div class="column">
  <p>Having arrived at your Master year, a counter is not exactly rocket science, nor brain surgery (<a href="https://youtu.be/THNPmhBl-8I?si=dO2R8b0iyGD4_-Lm" target="_blank">lol</a>). The simple design that is shown, is a counter that either be incremented or cleared.</p>
<p>Note that this is <strong>not</strong> a special component, but a simple register with a load. The multiplexer and the adder add the functionality of a counter to the register.</p>
</div>    
</div>    
<h2 id="gluing-things-together">Gluing things together</h2>
<p>The counter that is described above has two 1-bit inputs and one 32-bit output. If we want to control this counter from the processor, these signals should be writeable/readable by the processor. For this the register approach from the previous section is used. One single register is used to &ldquo;direct&rdquo; the functional block. Such a register is often referred to as a <strong>command register (CR)</strong>.</p>
<p><img src="../../img/300/apbcounter.png" alt="example"></p>
<p>By simply wiring (for example) the LSB of <em>REG 0</em> to the <strong>increment</strong> input of the counter, a link is made. Similarly the bit at index (1) of <em>REG 0</em> can be mapped to the <strong>clear</strong> input. With this configuration, writing to <em>REG 0</em> controls the counter.</p>
<p>The CR could also be read back. This <strong>will</strong> come in handy. Next to reading the CR, reading back the value of the counter might be useful. Otherwise, the peripheral would be sort-of pointless.</p>
<h2 id="memory-map">Memory map</h2>
<p>In earlier sections the memory was (briefly) discussed. As the SOC uses a 32-bit vector for addresses, this defines the memory space. The lowest addressable memory locations is 0x00000000 (aka <em>zero</em>), while the highest memory location is 0xFFFFFFFF (aka <em>all foxes</em>).</p>
<p>There is no doubt that you can write a program that takes <strong>1'073'741'824 instructions</strong> (1 billion !!! Mind you, in Dutch this is &ldquo;één miljard&rdquo;). With SoCs it would be more realistic if the instruction memory is smaller than <strong>4.3 TeraByte</strong> &#x1f603;. Typically the firmware indeed starts at address 0x0, but it is capped at a maximum.</p>
<div class="multiHcolumn">
<div class="column">
  <p><img src="../../img/300/memmap.png" alt="example"></p>
</div>    
<div class="column">
  <p>To allow you to write loads of code, it is assumed (for this course) that the instruction memory will never be larger than 0x7FFFFFFF addresses. The remainder of the available memory space is reserved for <strong>segmentation</strong>.</p>
<p>This leaves half of the memory space to allocate as we see fit. As an example the segment for this counter peripheral is placed at address 0x8F000000. In OS-lingo this is called the <strong>Base Address (BA)</strong>. When we assign for example 1024 addresses for the counter, the <strong>High Address (HA)</strong> is 0x8F000FFF.</p>
<p>You might have noticed that the PicoRV32 has a parameter that sets the address of the <strong>stack pointer</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>	<span style="color:#66d9ef">parameter</span> [<span style="color:#ae81ff">31</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] STACKADDR <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>&#39;h ffff_ffff</span></span></code></pre></div>
</div>    
</div>    
<p>With the memory map as described above, simply writing (in software) the value 1 to address 0x81000000, will enable the counter. Writing a value 0, will stop the counter. To clear the value of the counter a value of 2 has to be written to the CR.</p>

<div class="notices warning" ><p>Note that a default write transfer writes 32 bits. Writing a value of 1 to the CR, will not only set the LSB to one, <strong>it also sets all other bits to zero !!</strong>
<br/><br/>
A default technique to set the bit with index 5 of CR, is to: 1) read the value of CR; 2)apply a mask so the 6th(!) bit is set, and 3) write back the result. This is the reason why it is also useful to be able to read back the value of CR.
<br/><br/>
CR |= (1&laquo;5); /* clearing can we done with: CR &amp;= ~(1&laquo;5); */</p>
</div>

<h3 id="double-drivers">Double drivers</h3>
<p>One more thing to point out is double drivers. As you know, every gate can only be driven by a single source. The following scenario can be tempting.</p>
<p>Let&rsquo;s assume 2 registers for this APB counter functional block. One could be assigned as the CR and the other one can act as a <strong>status register (SR)</strong>. In the example above this could be translate to <em>REG 0</em> is CR and counter is SR.</p>
<p>Be aware that the counter cannot be used in the same way as <em>REG 0</em>. It should either be writeable through the APB (or any) bus, or through some other part of the design.</p>
<h2 id="example">Example</h2>
<p>The example below shows a simulation. First, a write of the value <strong>0x1</strong> is done to address <strong>0x81000000</strong>. This starts the counter. After a certain amount of time, a write of the value <strong>0x0</strong> is done to the same address. This stops the counter. Finally a read on address <strong>0x81000004</strong> is done to obtain the counter value.</p>
<p><img src="../../img/300/waveform_counter.png" alt="example"></p>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
		
			<a class="nav nav-next" href="../../10_compiling/" title="1 Setting the playing field" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1739605499"></script>
    <script src="../../js/perfect-scrollbar.min.js?1739605499"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1739605499"></script>
    <script src="../../js/jquery.sticky.js?1739605499"></script>
    <script src="../../js/featherlight.min.js?1739605499"></script>
    <script src="../../js/highlight.pack.js?1739605499"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js?1739605499"></script>
    <script src="../../js/learn.js?1739605499"></script>
    <script src="../../js/hugo-learn.js?1739605499"></script>
    
        
            <script src="../../mermaid/mermaid.js?1739605499"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

