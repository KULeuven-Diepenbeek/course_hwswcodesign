<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.123.7">
    <meta name="description" content="">
<meta name="author" content="map[email:&lt;i&gt;fname&lt;/i&gt;.&lt;i&gt;lname&lt;/i&gt;A T&lt;i&gt;kuleuven.be&lt;/i&gt; name:Jo Vliegen]">

    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>4.2 - Zicsr :: HW/SW codesign</title>

    
    <link href="../../css/nucleus.css?1742892177" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1742892177" rel="stylesheet">
    <link href="../../css/hybrid.css?1742892177" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1742892177" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1742892177" rel="stylesheet">
    <link href="../../css/auto-complete.css?1742892177" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css?1742892177" rel="stylesheet">
    <link href="../../css/theme.css?1742892177" rel="stylesheet">
    <link href="../../css/tabs.css?1742892177" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1742892177" rel="stylesheet">
    
    <link href="../../css/theme-kul.css?1742892177" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1742892177"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src=../../js/exercises.js></script> 
  </head>
  <body class="" data-url="../../40_interrupts/42_zicsr/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://www.kuleuven.be/kuleuven/" target="_blank">
  <img src="../../img/style/kul.png" alt="KU Leuven" /><br/>
</a>
<a href="https://www.uhasselt.be/" target="_blank">
  <img src="../../img/style/uhasselt.svg" alt="UHasselt" id="uhlogo" />
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1742892177"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1742892177"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/kuleuven-diepenbeek.github.io\/course_hwswcodesign\/";
    
</script>
<script type="text/javascript" src="../../js/search.js?1742892177"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/10_compiling/" title="1 Setting the playing field" class="dd-item
        
        
        
        ">
      <a href="../../10_compiling/">
          1 Setting the playing field
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/11_programming/" title="1.1 - Programming the RISC-V" class="dd-item ">
        <a href="../../10_compiling/11_programming/">
        <i class='fas fa-book'></i> 1.1 - Programming the RISC-V
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/12_compiling_bare_metal/" title="1.2 - Compiling Bare Metal" class="dd-item ">
        <a href="../../10_compiling/12_compiling_bare_metal/">
        <i class='fas fa-book'></i> 1.2 - Compiling Bare Metal
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/13_linking_bare_metal/" title="1.3 - Linking Bare Metal" class="dd-item ">
        <a href="../../10_compiling/13_linking_bare_metal/">
        <i class='fas fa-book'></i> 1.3 - Linking Bare Metal
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/14_simulation/" title="1.4 - Simulation" class="dd-item ">
        <a href="../../10_compiling/14_simulation/">
        <i class='fas fa-book'></i> 1.4 - Simulation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/10_compiling/15_exercises/" title="1.5 - Exercises" class="dd-item ">
        <a href="../../10_compiling/15_exercises/">
        <i class='fas fa-pen'></i> 1.5 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/20_hw/" title="2 Making it work on hardware" class="dd-item
        
        
        
        ">
      <a href="../../20_hw/">
          2 Making it work on hardware
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/20_hw/21_current_situation/" title="2.1 - The current situation" class="dd-item ">
        <a href="../../20_hw/21_current_situation/">
        <i class='fas fa-book'></i> 2.1 - The current situation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/22_wrapping/" title="2.2 - Wrapping it up" class="dd-item ">
        <a href="../../20_hw/22_wrapping/">
        <i class='fas fa-book'></i> 2.2 - Wrapping it up
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/23_onemore/" title="2.3 - One more thing ..." class="dd-item ">
        <a href="../../20_hw/23_onemore/">
        <i class='fas fa-book'></i> 2.3 - One more thing ...
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/24_go_fast/" title="2.4 - Go as fast as you can" class="dd-item ">
        <a href="../../20_hw/24_go_fast/">
        <i class='fas fa-book'></i> 2.4 - Go as fast as you can
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/20_hw/25_exercises/" title="2.5 - Exercises" class="dd-item ">
        <a href="../../20_hw/25_exercises/">
        <i class='fas fa-pen'></i> 2.5 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/30_counter/" title="3 Once upon a time(r)" class="dd-item
        
        
        
        ">
      <a href="../../30_counter/">
          3 Once upon a time(r)
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/30_counter/31_timer/" title="3.1 - SW Timer" class="dd-item ">
        <a href="../../30_counter/31_timer/">
        <i class='fas fa-book'></i> 3.1 - SW Timer
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/30_counter/32_timer_counter/" title="3.2 - HW Timer" class="dd-item ">
        <a href="../../30_counter/32_timer_counter/">
        <i class='fas fa-book'></i> 3.2 - HW Timer
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/30_counter/33_tcnt_use/" title="3.3 - Using TCNT" class="dd-item ">
        <a href="../../30_counter/33_tcnt_use/">
        <i class='fas fa-book'></i> 3.3 - Using TCNT
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/30_counter/34_cost/" title="3.4 - How much bang do you get for your buck?" class="dd-item ">
        <a href="../../30_counter/34_cost/">
        <i class='fas fa-book'></i> 3.4 - How much bang do you get for your buck?
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/30_counter/35_exercises/" title="3.5 - Exercises" class="dd-item ">
        <a href="../../30_counter/35_exercises/">
        <i class='fas fa-pen'></i> 3.5 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/40_interrupts/" title="4 Interrupts" class="dd-item
        parent
        
        
        ">
      <a href="../../40_interrupts/">
          4 Interrupts
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/40_interrupts/41_interrupt/" title="4.1 - Interrupt" class="dd-item ">
        <a href="../../40_interrupts/41_interrupt/">
        <i class='fas fa-book'></i> 4.1 - Interrupt
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/40_interrupts/42_zicsr/" title="4.2 - Zicsr" class="dd-item active">
        <a href="../../40_interrupts/42_zicsr/">
        <i class='fas fa-book'></i> 4.2 - Zicsr
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/40_interrupts/43_exercises/" title="4.3 - Exercises" class="dd-item ">
        <a href="../../40_interrupts/43_exercises/">
        <i class='fas fa-pen'></i> 4.3 - Exercises
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/50_qoi/" title="5 QOI" class="dd-item
        
        
        
        ">
      <a href="../../50_qoi/">
          5 QOI
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/50_qoi/51_digital_image/" title="5.1 Digital image" class="dd-item ">
        <a href="../../50_qoi/51_digital_image/">
        <i class='fas fa-book'></i> 5.1 Digital image
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/50_qoi/52_image_formats/" title="5.2 Image formats" class="dd-item ">
        <a href="../../50_qoi/52_image_formats/">
        <i class='fas fa-book'></i> 5.2 Image formats
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/50_qoi/53_example/" title="5.3 Example" class="dd-item ">
        <a href="../../50_qoi/53_example/">
        <i class='fas fa-book'></i> 5.3 Example
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/50_qoi/54_project/" title="5.4 Project" class="dd-item ">
        <a href="../../50_qoi/54_project/">
        <i class='fas fa-pen'></i> 5.4 Project
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://studiegidswww.uhasselt.be/opleidingsonderdeel.aspx?a=2023&amp;i=3468&amp;n=4&amp;t=04"><i class='fa fa-university'></i> ECTS Sheet</a>
              </li>
          
              <li>
                  <a class="padding" href="https://p.cygnus.cc.kuleuven.be/webapps/blackboard/execute/announcement?method=search&amp;context=course&amp;course_id=_1176295_1&amp;handle=cp_announcements&amp;mode=cpview"><i class='fa fa-university'></i> Toledo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../'>HWSW codesign</a> > <a href='../../40_interrupts/'>4 Interrupts</a> > 4.2 - Zicsr
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#instructions">Instructions</a></li>
    <li><a href="#zicsr-registers">Zicsr registers</a></li>
    <li><a href="#when-an-interrupt-presents-itself-">When an interrupt presents itself &hellip;</a></li>
    <li><a href="#informing-the-compiler">Informing the compiler</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              4.2 - Zicsr
            </h1>
          

        


<h2 id="instructions">Instructions</h2>
<p>The RISC-V specifications describe how interrupts should be handled in RISC-V. This is covered (among other things) in an <strong>extension</strong>: <strong>Zicsr</strong>. RISC-V refers to an external asynchronous event that may cause a RISC-V core to execute an unexpected transfer of control as <strong>interrupt</strong>. Similarly, <em>an unusual condition</em> occurring at the run time (due to invalid instructions etc.) is referred to as <strong>exceptions</strong>. The term <strong>trap</strong> is used to collectively refer to interrupt or exception.</p>
<p>A separate address space of <strong>4096 Control and Status registers</strong> are associated with each hart. Six additional instructions are provided to interract with these registers.</p>
<figure><img src="../../img/40/zicsr_instructions.png"/>
</figure>
<p>These instructions perform <strong>atomic</strong> substitutions between the CSR register and either a register from the registerfile or an immediate value.</p>
<figure><img src="../../img/40/exchange.png"/>
</figure>
<table>
<thead>
<tr>
<th>Register name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CSRRW rd, CSR_ID, rs1</td>
<td>Write <strong>rs1</strong> to the register CRS_ID while reading the content of CRS_ID into <strong>rd</strong></td>
</tr>
<tr>
<td>CSRRS rd, CSR_ID, rs1</td>
<td>Write <strong>CRS_ID <u>OR</u> rs1</strong> to the register CRS_ID while reading the content of CRS_ID into <strong>rd</strong></td>
</tr>
<tr>
<td>CSRRC rd, CSR_ID, rs1</td>
<td>Write <strong>CRS_ID <u>AND</u> not(rs1)</strong> to the register CRS_ID while reading the content of CRS_ID into <strong>rd</strong></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>CSRRWI rd, CSR_ID, <em>value</em></td>
<td>identical to CSRRW but with an immediate value in stead of <strong>rs1</strong></td>
</tr>
<tr>
<td>CSRRSI rd, CSR_ID, <em>value</em></td>
<td>identical to CSRRS but with an immediate value in stead of <strong>rs1</strong> (setting bits)</td>
</tr>
<tr>
<td>CSRRCI rd, CSR_ID, <em>value</em></td>
<td>identical to CSRRC but with an immediate value in stead of <strong>rs1</strong> (clearing bits)</td>
</tr>
</tbody>
</table>
<h2 id="zicsr-registers">Zicsr registers</h2>
<p>Although not all 4096 registers that are addressable are used, in this course even fewer registers are discussed. The most relevant registers for this course are enumerated here.</p>
<div style="margin-left: 10%">
<ul>
<li> <b>CSR_MRO_mhartid</b> (address: 0xF14): This register holds the <b>ID</b> of the RISC-V core
<li> <b>CSR_MRW_mstatus</b> (address: 0x300): This register holds 32 bits of <b>status bits</b>
<li> <b>CSR_MRW_misa</b> (address: 0x301): This register an <b>identifier</b> of the ISA
<li> <b>CSR_MRW_mie</b> (address: 0x304): This register masks which <b>interrupts</b> are enabled
<li> <b>CSR_MRW_mtvec</b> (address: 0x305): This register holds the address of the <b>context vector</b>
<li> <b>CSR_MRW_mstatush</b> (address: 0x310): This register holds another 32 bits of <b>status bits</b>
<li> <b>CSR_MRW_mscratch</b> (address: 0x340): This register hold the address for the <b>context space</b>
<li> <b>CSR_MRW_mepc</b> (address: 0x341): This register serves as backup register for the <b>program counter</b>
<li> <b>CSR_MRW_mcause</b> (address: 0x342): This register samples the <b>cause</b> of the interrupt
<li> <b>CSR_MRW_mip</b> (address: 0x344): This register hold <b>pending</b> requests
</ul>
</div>
<h2 id="when-an-interrupt-presents-itself-">When an interrupt presents itself &hellip;</h2>
<p>When an interrupt presents itself the RISC-V needs to jump to the interrupt handler. However, when the interrupt is handled, the processor should continue where it left. This is achieved by the following steps</p>
<ol>
<li><strong>[Program Counter]</strong>: Load the program counter with a pointer to the <span style="background-color: #FFE6CC; color: #D79B00"> trap vector </span>, while making a backup of the program counter in <b>CSR_MRW_mepc</b> register of the Zicsr. This requires a modification in the hardware.</li>
<li><strong>[Stack Pointer]</strong>: The <strong>context</strong> of the processor is the state of all the registers. Before these registers can be backed up, one register needs to be freed. RISC-V uses the <strong>stack pointer</strong> for this. The current value is swapped with the <b>CSR_MRW_mscratch</b> register of the Zicsr.</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>    csrrw sp, mscratch, sp
</span></span></code></pre></div>  </div>    
<ol start="3">
<li><strong>[Regfile backup]</strong>: With the stack pointer set, a backup of all 30 (!) registers can be made on the stack.</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>	sw x1,   <span style="color:#ae81ff">0</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>	sw x3,   <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>	sw x4,   <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span>	sw x31,   <span style="color:#ae81ff">29</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span></code></pre></div>  </div>    
<ol start="4">
<li><strong>[Cause]</strong>: Fetch the cause of the interrupt from the <strong>CSR_MRW_mcause</strong> register, store it in <strong>reg a0</strong> and call the <span style="background-color: #F5F5F5; color: #666666"> interrupt handler </span>.</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>    csrrc a0, mcause, zero
</span></span><span style="display:flex;"><span>    jal ra, irq_handler
</span></span></code></pre></div>  </div>    
<ol start="5">
<li><strong>[Restore Regfile]</strong>:</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>   lw x1,   <span style="color:#ae81ff">0</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>   lw x3,   <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>   lw x4,   <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span>   lw x31,   <span style="color:#ae81ff">29</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>(sp)
</span></span></code></pre></div>  </div>    
<ol start="6">
<li><strong>[Restore SP]</strong>: The current value is swapped again  with the <b>CSR_MRW_mscratch</b> register of the Zicsr.</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>    csrrw sp, mscratch, sp
</span></span></code></pre></div>  </div>    
<ol start="7">
<li><strong>[Return from Trap Vector]</strong>: This can be done with a special instruction.</li>
</ol>
 <div class="centeredColumn50">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-S" data-lang="S"><span style="display:flex;"><span>    mret
</span></span></code></pre></div>  </div>    
<div class="multiHcolumn">
<div class="column">
  <figure><img src="../../img/40/memory_map_wo_irq.png"/>
</figure>
</div>    
<div class="column">
  <p>The software was organised as shown on the left. Upon reset, the initialisation was done in the <span style="background-color: #DAE8FC; color: #6C8EBF"> start </span> section. Here, all registers get initialised, the stack pointer is set to 0x1000 and a jump is done to the <span style="background-color: #D5E8D4; color: #82B366"> main </span> function. All other <span style="background-color: #F5F5F5; color: #666666"> functions </span> are compiled and are linked somewhere in the instruction memory.</p>
<p>To allow for interrupts these sections have to move a little bit further down. This makes room for a <span style="background-color: #F8CECC; color: #B85450"> reset vector </span> and a <span style="background-color: #FFE6CC; color: #D79B00"> trap vector </span>.</p>
<p>The <span style="background-color: #F8CECC; color: #B85450"> reset vector </span> is a very short set of instructions that mainly prepares the processor to <span style="background-color: #DAE8FC; color: #6C8EBF"> do reset </span>. The reason for adding this section is that the processor can keep starting operation at address 0x0 and that the trap vector can start very early on a <strong>fixed address</strong>.</p>
<p>When an interrupt is present, the RISC-V should jump to the <span style="background-color: #FFE6CC; color: #D79B00"> trap vector </span>. Here a backup-copy is made of all the registers to the stack, the interrupt handler is called, after which all registers are restored from the stack.</p>
</div>    
<div class="column">
  <figure><img src="../../img/40/memory_map_w_irq.png"/>
</figure>
</div>    
</div>    
<!-- 
While CSRs are primarily used by the privileged architecture, there are several uses in unprivileged code including for counters and timers, and for floating-point status.

The counters and timers are no longer considered mandatory parts of the standard base ISAs, and so the CSR instructions required to access them have been moved out of Chapter [rv32] into this separate chapter.


RISC-V supports two main trap handling mechanisms: **direct** and **vectored**. Based on the last 2 bits of the mtvec register (or stvec for ‘S’ mode), it could be either perform Direct handling (bit values – 00) or Vectored handling (bit values – 01).


Conditions for interrupt to M-mode

* current priv mode is M and the MIE-bit in **mstatus**-reg is set
* i-bit is set in **mip** and **mie**
* [if -e mideleg] and !mideleg(i)

These conditions for an interrupt trap to occur must be evaluated in a bounded amount of time from
when an interrupt becomes, or ceases to be, pending in mip, and must also be evaluated immediately
following the execution of an xRET instruction or an explicit write to a CSR on which these interrupt
trap conditions expressly depend (including mip, mie, mstatus, and mideleg).

mip(13) <= lcofip   -- (RO) '0' when Sscofpmf extension is not implemented
mip(11) <= meip     -- interrupt pending for machine-level external interrupts (RO) is set and cleared by a platform-specific interrupt controller
mip(9) <= seip      -- (RO) '0' when S-mode is not implemented
mip(7) <= mtip      -- interrupt pending for machine timer interrupts (RO) is cleared by writing to the memory-mapped machine-mode timer compare register.
mip(5) <= stip      -- (RO) '0' when S-mode is not implemented
mip(3) <= msip      -- interrupt pending for software interrupts (RO) is written by accesses to memory-mapped control registers,
mip(1) <= ssip      -- (RO) '0' when S-mode is not implemented

mie(13) <= lcofie   -- (RO) '0' when Sscofpmf extension is not implemented
mie(11) <= meie     -- interrupt enable for machine-level external interrupts
mie(9) <= seie      -- (RO) '0' when S-mode is not implemented
mie(7) <= mtie      -- interrupt enable for machine timer interrupts
mie(5) <= stie      -- (RO) '0' when S-mode is not implemented
mie(3) <= msie      -- interrupt enable for software interrupts 
mie(1) <= ssie      -- (RO) '0' when S-mode is not implemented



Multiple simultaneous interrupts destined for M-mode are handled in the following decreasing
priority order: MEI, MSI, MTI, SEI, SSI, STI, LCOFI.
machine-level external, software, timer
software-level external, software, timer -->
<h2 id="informing-the-compiler">Informing the compiler</h2>
<p>As the firmware also includes Zicsr instructions now, the compiler has to be notified of this. In the Makefile, the flags for the compiler can do this trick. The parameter <strong>arch</strong> needs to be changed from <strong>rv32i</strong> to <strong>rv32i_zicsr</strong>.</p>
<div class="multiHcolumn">
<div class="column">
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>ARCHITECTURE <span style="color:#f92672">=</span> rv32i
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span></code></pre></div>
</div>    
<div class="column">
  <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>ARCHITECTURE <span style="color:#f92672">=</span> rv32i_zicsr
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span></code></pre></div>
</div>    
</div>    

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="../../40_interrupts/41_interrupt/" title="4.1 - Interrupt"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../40_interrupts/43_exercises/" title="4.3 - Exercises" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1742892177"></script>
    <script src="../../js/perfect-scrollbar.min.js?1742892177"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1742892177"></script>
    <script src="../../js/jquery.sticky.js?1742892177"></script>
    <script src="../../js/featherlight.min.js?1742892177"></script>
    <script src="../../js/highlight.pack.js?1742892177"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js?1742892177"></script>
    <script src="../../js/learn.js?1742892177"></script>
    <script src="../../js/hugo-learn.js?1742892177"></script>
    
        
            <script src="../../mermaid/mermaid.js?1742892177"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

